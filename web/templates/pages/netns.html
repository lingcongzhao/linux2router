{{define "netns.html"}}
{{template "base" .}}
{{end}}

{{define "content"}}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">Network Namespaces</h2>
            <p class="mt-1 text-sm text-gray-500">Isolated network environments with their own interfaces, routes, and firewall rules</p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0 space-x-3">
            <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-500">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Namespace
            </button>
            <button onclick="document.getElementById('vethModal').classList.remove('hidden')" class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                Create Veth Pair
            </button>
            <button hx-post="/netns/save" hx-target="#alert-container" class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white hover:bg-green-500">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                </svg>
                Save Config
            </button>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Namespaces Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div id="netns-table" hx-get="/netns/list" hx-trigger="load, refresh from:body, every 10s" hx-swap="innerHTML">
            {{template "netns_table" .}}
        </div>
    </div>
</div>

<!-- Add Namespace Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Create Network Namespace</h3>
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form hx-post="/netns" hx-target="#alert-container" hx-on::after-request="if(event.detail.successful) { document.getElementById('addModal').classList.add('hidden'); refreshNamespaceDropdown(); }">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Namespace Name</label>
                    <input type="text" name="name" required placeholder="my-namespace" pattern="[a-zA-Z0-9_-]+" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500">Alphanumeric characters, dashes, and underscores only</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500">Create Namespace</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Veth Pair Modal -->
<div id="vethModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Create Veth Pair</h3>
            <button onclick="document.getElementById('vethModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form hx-post="/netns/veth" hx-target="#alert-container" hx-on::after-request="if(event.detail.successful) document.getElementById('vethModal').classList.add('hidden')">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Interface 1 (Default NS)</label>
                        <input type="text" name="name1" required placeholder="veth0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Interface 2 (Target NS)</label>
                        <input type="text" name="name2" required placeholder="veth1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Target Namespace</label>
                    <select name="namespace" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                        <option value="">Select namespace...</option>
                        {{range .Namespaces}}
                        <option value="{{.Name}}">{{.Name}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address 1 (Optional)</label>
                        <input type="text" name="address1" placeholder="10.0.0.1/24" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address 2 (Optional)</label>
                        <input type="text" name="address2" placeholder="10.0.0.2/24" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="document.getElementById('vethModal').classList.add('hidden')" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-500">Create Veth Pair</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4" id="confirmTitle">Confirm Action</h3>
        <p class="text-sm text-gray-500 mb-6" id="confirmMessage">Are you sure?</p>
        <div class="flex justify-end space-x-3">
            <button onclick="document.getElementById('confirmModal').classList.add('hidden')" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
            <button id="modal-confirm-btn" class="rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-500" onclick="executeModalAction()">Confirm</button>
        </div>
    </div>
</div>

<script>
var modalActionUrl = null;
var modalActionMethod = 'DELETE';

function showActionModal(btn) {
    modalActionUrl = btn.getAttribute('data-action');
    modalActionMethod = btn.getAttribute('data-method') || 'DELETE';
    var message = btn.getAttribute('data-message') || 'Are you sure?';
    
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').classList.remove('hidden');
}

function executeModalAction() {
    if (!modalActionUrl) return;
    
    var options = { method: modalActionMethod, credentials: 'same-origin' };
    if (pendingBody) {
        options.headers = {'Content-Type': 'application/x-www-form-urlencoded'};
        options.body = pendingBody;
    }
    
    fetch(modalActionUrl, options)
        .then(function(response) { return response.text(); })
        .then(function(html) {
            var alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                alertContainer.innerHTML = html;
            }
            setTimeout(function() { window.location.reload(); }, 300);
        });
    
    document.getElementById('confirmModal').classList.add('hidden');
    modalActionUrl = null;
}

function refreshNamespaceDropdown() {
    fetch('/netns/options')
        .then(function(response) { return response.text(); })
        .then(function(html) {
            var select = document.querySelector('#vethModal select[name="namespace"]');
            if (select) {
                select.innerHTML = html;
            }
        })
        .catch(function(err) { console.error('Failed to refresh namespace dropdown:', err); });
}
</script>
{{end}}
